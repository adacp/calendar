<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#9333ea">
    <meta name="description" content="Calendario personal para gestionar tus eventos">
    <title>Mi Calendario</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
        // Iconos SVG simples
        const icons = {
            calendar: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>',
            plus: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',
            x: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',
            clock: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',
            edit: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>',
            trash: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',
            upload: '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>',
            download: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>'
        };

        // Estado de la aplicaci√≥n
        let state = {
            events: [],
            showForm: false,
            selectedDate: new Date(),
            formData: { title: '', date: '', time: '', description: '' },
            editingId: null,
            showInstallButton: false,
            monthImages: {},
            showImageUpload: false,
            deferredPrompt: null
        };

        const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const days = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];

        // Funciones de almacenamiento
        function loadEvents() {
            try {
                const saved = localStorage.getItem('calendar-events');
                if (saved) state.events = JSON.parse(saved);
            } catch (e) {}
        }

        function saveEvents() {
            localStorage.setItem('calendar-events', JSON.stringify(state.events));
        }

        function loadMonthImages() {
            try {
                const saved = localStorage.getItem('calendar-month-images');
                if (saved) state.monthImages = JSON.parse(saved);
            } catch (e) {}
        }

        function saveMonthImages() {
            localStorage.setItem('calendar-month-images', JSON.stringify(state.monthImages));
        }

        function getCurrentMonthImage() {
            const key = `${state.selectedDate.getFullYear()}-${state.selectedDate.getMonth()}`;
            return state.monthImages[key];
        }

        function getDaysInMonth(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            return {
                daysInMonth: lastDay.getDate(),
                startingDayOfWeek: firstDay.getDay()
            };
        }

        function getEventsForDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            return state.events.filter(e => e.date === dateStr);
        }

        function formatDate(dateStr) {
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }

        // Renderizar la aplicaci√≥n
        function render() {
            const currentImage = getCurrentMonthImage();
            const { daysInMonth, startingDayOfWeek } = getDaysInMonth(state.selectedDate);
            
            const upcomingEvents = [...state.events]
                .sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + (a.time || '00:00'));
                    const dateB = new Date(b.date + ' ' + (b.time || '00:00'));
                    return dateA - dateB;
                })
                .filter(e => new Date(e.date + 'T00:00:00') >= new Date(new Date().toDateString()));

            let calendarCells = '';
            for (let i = 0; i < startingDayOfWeek; i++) {
                calendarCells += '<div class="aspect-square"></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(state.selectedDate.getFullYear(), state.selectedDate.getMonth(), day);
                const dayEvents = getEventsForDate(date);
                const isToday = new Date().toDateString() === date.toDateString();
                
                let eventsHtml = '';
                if (dayEvents.length > 0) {
                    dayEvents.slice(0, 2).forEach(event => {
                        eventsHtml += `<div class="text-xs bg-purple-500 text-white rounded px-1 truncate" title="${event.title}">${event.title}</div>`;
                    });
                    if (dayEvents.length > 2) {
                        eventsHtml += `<div class="text-xs text-gray-500">+${dayEvents.length - 2}</div>`;
                    }
                }

                calendarCells += `
                    <div onclick="handleDayClick(${day})" 
                         class="aspect-square border rounded-lg p-1 flex flex-col cursor-pointer transition hover:shadow-md ${isToday ? 'bg-blue-50 border-blue-500' : 'border-gray-200 hover:border-purple-300'}">
                        <div class="text-sm font-semibold ${isToday ? 'text-blue-600' : 'text-gray-700'}">${day}</div>
                        <div class="flex-1 flex flex-col gap-0.5 mt-1 overflow-hidden">${eventsHtml}</div>
                    </div>
                `;
            }

            let upcomingHtml = '';
            if (upcomingEvents.length > 0) {
                upcomingEvents.slice(0, 5).forEach(event => {
                    upcomingHtml += `
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-800 text-lg">${event.title}</h3>
                                    <div class="flex items-center gap-4 mt-2 text-sm text-gray-600">
                                        <span>üìÖ ${formatDate(event.date)}</span>
                                        ${event.time ? `<span class="flex items-center gap-1">${icons.clock} ${event.time}</span>` : ''}
                                    </div>
                                    ${event.description ? `<p class="text-gray-600 mt-2">${event.description}</p>` : ''}
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editEvent('${event.id}')" class="text-blue-600 hover:bg-blue-50 p-2 rounded-lg transition">${icons.edit}</button>
                                    <button onclick="deleteEvent('${event.id}')" class="text-red-600 hover:bg-red-50 p-2 rounded-lg transition">${icons.trash}</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            const html = `
                <div class="min-h-screen bg-gradient-to-br from-purple-100 to-blue-100 p-4">
                    <div class="max-w-4xl mx-auto">
                        ${state.showInstallButton ? `
                            <div class="bg-purple-600 text-white p-4 rounded-2xl shadow-lg mb-4 flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="font-semibold">üì± Instala la app en tu m√≥vil</p>
                                    <p class="text-sm text-purple-100">Accede m√°s r√°pido a tu calendario</p>
                                </div>
                                <button onclick="installApp()" class="bg-white text-purple-600 px-4 py-2 rounded-lg font-semibold hover:bg-purple-50 transition flex items-center gap-2">
                                    ${icons.download} Instalar
                                </button>
                            </div>
                        ` : ''}

                        <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-6">
                            ${currentImage ? `
                                <div class="relative h-48 overflow-hidden group">
                                    <img src="${currentImage}" alt="Banner" class="w-full h-full object-cover">
                                    <div class="absolute inset-0 bg-gradient-to-b from-transparent to-black/50 flex items-end">
                                        <h2 class="text-white text-3xl font-bold p-6">${months[state.selectedDate.getMonth()]} ${state.selectedDate.getFullYear()}</h2>
                                    </div>
                                    <button onclick="removeMonthImage()" class="absolute top-4 right-4 bg-red-500 text-white p-2 rounded-lg opacity-0 group-hover:opacity-100 transition">${icons.x}</button>
                                </div>
                            ` : `
                                <div onclick="state.showImageUpload = true; render();" class="h-48 bg-gradient-to-r from-purple-400 to-blue-400 flex flex-col items-center justify-center cursor-pointer hover:from-purple-500 hover:to-blue-500 transition">
                                    ${icons.upload}
                                    <p class="text-white text-lg font-semibold">A√±adir imagen del mes</p>
                                    <p class="text-purple-100 text-sm">Click para subir</p>
                                </div>
                            `}

                            <div class="p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <div class="flex items-center gap-3">
                                        ${icons.calendar}
                                        <h1 class="text-3xl font-bold text-gray-800">Mi Calendario</h1>
                                    </div>
                                    <button onclick="openNewEventForm()" class="bg-purple-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-purple-700 transition">
                                        ${icons.plus} Nuevo
                                    </button>
                                </div>

                                <div class="flex items-center justify-between mb-4">
                                    <button onclick="changeMonth(-1)" class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition">‚Üê Anterior</button>
                                    ${!currentImage ? `<button onclick="state.showImageUpload = true; render();" class="text-sm text-purple-600 hover:text-purple-700 flex items-center gap-1">A√±adir imagen</button>` : ''}
                                    <button onclick="changeMonth(1)" class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition">Siguiente ‚Üí</button>
                                </div>

                                <div class="grid grid-cols-7 gap-2 mb-2">
                                    ${days.map(d => `<div class="text-center font-semibold text-gray-600 text-sm">${d}</div>`).join('')}
                                </div>

                                <div class="grid grid-cols-7 gap-2">${calendarCells}</div>

                                <p class="text-sm text-gray-500 mt-4 text-center">üí° Click en cualquier d√≠a para a√±adir un evento</p>
                            </div>
                        </div>

                        ${upcomingEvents.length > 0 ? `
                            <div class="bg-white rounded-2xl shadow-xl p-6">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">Pr√≥ximos Eventos</h2>
                                <div class="space-y-3">${upcomingHtml}</div>
                            </div>
                        ` : ''}
                    </div>

                    ${state.showImageUpload ? `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-2xl font-bold text-gray-800">Imagen para ${months[state.selectedDate.getMonth()]}</h2>
                                    <button onclick="state.showImageUpload = false; render();" class="text-gray-500 hover:bg-gray-100 p-2 rounded-lg transition">${icons.x}</button>
                                </div>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-purple-500 transition">
                                    <input type="file" accept="image/*" onchange="handleImageUpload(event)" id="imageUpload" class="hidden">
                                    <label for="imageUpload" class="cursor-pointer">
                                        <div class="text-gray-400 mb-2">${icons.upload}</div>
                                        <p class="text-gray-600 mb-4">Selecciona una imagen</p>
                                        <span class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition inline-block">Elegir archivo</span>
                                        <p class="text-sm text-gray-500 mt-2">JPG, PNG o GIF</p>
                                    </label>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    ${state.showForm ? `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-2xl font-bold text-gray-800">${state.editingId ? 'Editar Evento' : 'Nuevo Evento'}</h2>
                                    <button onclick="closeForm()" class="text-gray-500 hover:bg-gray-100 p-2 rounded-lg transition">${icons.x}</button>
                                </div>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">T√≠tulo *</label>
                                        <input type="text" id="eventTitle" value="${state.formData.title}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Cumplea√±os, cita, reuni√≥n...">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Fecha *</label>
                                        <input type="date" id="eventDate" value="${state.formData.date}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Hora (opcional)</label>
                                        <input type="time" id="eventTime" value="${state.formData.time}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Descripci√≥n (opcional)</label>
                                        <textarea id="eventDesc" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Detalles adicionales...">${state.formData.description}</textarea>
                                    </div>
                                    <div class="flex gap-3 pt-4">
                                        <button onclick="closeForm()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">Cancelar</button>
                                        <button onclick="saveEvent()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">${state.editingId ? 'Guardar' : 'Crear'}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('root').innerHTML = html;
        }

        // Funciones de eventos
        function handleDayClick(day) {
            const year = state.selectedDate.getFullYear();
            const month = String(state.selectedDate.getMonth() + 1).padStart(2, '0');
            const dayStr = String(day).padStart(2, '0');
            state.formData = { title: '', date: `${year}-${month}-${dayStr}`, time: '', description: '' };
            state.editingId = null;
            state.showForm = true;
            render();
        }

        function openNewEventForm() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            state.formData = { title: '', date: `${year}-${month}-${day}`, time: '', description: '' };
            state.editingId = null;
            state.showForm = true;
            render();
        }

        function editEvent(id) {
            const event = state.events.find(e => e.id === id);
            state.formData = { ...event };
            state.editingId = id;
            state.showForm = true;
            render();
        }

        function deleteEvent(id) {
            if (confirm('¬øEliminar este evento?')) {
                state.events = state.events.filter(e => e.id !== id);
                saveEvents();
                render();
            }
        }

        function closeForm() {
            state.showForm = false;
            state.formData = { title: '', date: '', time: '', description: '' };
            state.editingId = null;
            render();
        }

        function saveEvent() {
            const title = document.getElementById('eventTitle').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const description = document.getElementById('eventDesc').value;

            if (!title || !date) {
                alert('Por favor completa t√≠tulo y fecha');
                return;
            }

            if (state.editingId) {
                state.events = state.events.map(e => 
                    e.id === state.editingId ? { id: state.editingId, title, date, time, description } : e
                );
            } else {
                state.events.push({ id: Date.now().toString(), title, date, time, description });
            }

            saveEvents();
            closeForm();
        }

        function changeMonth(delta) {
            state.selectedDate = new Date(state.selectedDate.getFullYear(), state.selectedDate.getMonth() + delta, 1);
            render();
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const key = `${state.selectedDate.getFullYear()}-${state.selectedDate.getMonth()}`;
                state.monthImages[key] = event.target.result;
                saveMonthImages();
                state.showImageUpload = false;
                render();
            };
            reader.readAsDataURL(file);
        }

        function removeMonthImage() {
            const key = `${state.selectedDate.getFullYear()}-${state.selectedDate.getMonth()}`;
            delete state.monthImages[key];
            saveMonthImages();
            render();
        }

        function installApp() {
            if (state.deferredPrompt) {
                state.deferredPrompt.prompt();
                state.deferredPrompt.userChoice.then(() => {
                    state.showInstallButton = false;
                    state.deferredPrompt = null;
                    render();
                });
            }
        }

        // Inicializar
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            state.deferredPrompt = e;
            state.showInstallButton = true;
            render();
        });

        window.addEventListener('load', () => {
            loadEvents();
            loadMonthImages();
            render();
        });

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg => console.log('Service Worker registrado'))
                .catch(err => console.log('Error Service Worker', err));
        }
    </script>
</body>
</html>
