<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#9333ea">
    <meta name="description" content="Calendario personal para gestionar tus eventos">
    <title>Mi Calendario</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Calendar, Plus, X, Clock, Edit2, Trash2, Download, Upload } = lucide;

        function CalendarApp() {
          const [events, setEvents] = useState([]);
          const [showForm, setShowForm] = useState(false);
          const [selectedDate, setSelectedDate] = useState(new Date());
          const [formData, setFormData] = useState({
            title: '',
            date: '',
            time: '',
            description: ''
          });
          const [editingId, setEditingId] = useState(null);
          const [deferredPrompt, setDeferredPrompt] = useState(null);
          const [showInstallButton, setShowInstallButton] = useState(false);
          const [monthImages, setMonthImages] = useState({});
          const [showImageUpload, setShowImageUpload] = useState(false);

          const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
          
          const days = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];

          useEffect(() => {
            loadEvents();
            loadMonthImages();
            
            const handleBeforeInstall = (e) => {
              e.preventDefault();
              setDeferredPrompt(e);
              setShowInstallButton(true);
            };

            window.addEventListener('beforeinstallprompt', handleBeforeInstall);

            return () => {
              window.removeEventListener('beforeinstallprompt', handleBeforeInstall);
            };
          }, []);

          const handleInstallClick = async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
              setShowInstallButton(false);
            }
            setDeferredPrompt(null);
          };

          const loadEvents = () => {
            try {
              const saved = localStorage.getItem('calendar-events');
              if (saved) {
                setEvents(JSON.parse(saved));
              }
            } catch (error) {
              console.log('No hay eventos guardados a√∫n');
            }
          };

          const loadMonthImages = () => {
            try {
              const saved = localStorage.getItem('calendar-month-images');
              if (saved) {
                setMonthImages(JSON.parse(saved));
              }
            } catch (error) {
              console.log('No hay im√°genes guardadas a√∫n');
            }
          };

          const saveEvents = (newEvents) => {
            try {
              localStorage.setItem('calendar-events', JSON.stringify(newEvents));
              setEvents(newEvents);
            } catch (error) {
              console.error('Error guardando eventos:', error);
            }
          };

          const saveMonthImages = (newImages) => {
            try {
              localStorage.setItem('calendar-month-images', JSON.stringify(newImages));
              setMonthImages(newImages);
            } catch (error) {
              console.error('Error guardando im√°genes:', error);
            }
          };

          const handleImageUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
              const monthKey = `${selectedDate.getFullYear()}-${selectedDate.getMonth()}`;
              const newImages = { ...monthImages, [monthKey]: event.target.result };
              saveMonthImages(newImages);
              setShowImageUpload(false);
            };
            reader.readAsDataURL(file);
          };

          const removeMonthImage = () => {
            const monthKey = `${selectedDate.getFullYear()}-${selectedDate.getMonth()}`;
            const newImages = { ...monthImages };
            delete newImages[monthKey];
            saveMonthImages(newImages);
          };

          const getCurrentMonthImage = () => {
            const monthKey = `${selectedDate.getFullYear()}-${selectedDate.getMonth()}`;
            return monthImages[monthKey];
          };

          const getDaysInMonth = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            return { daysInMonth, startingDayOfWeek };
          };

          const getEventsForDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            return events.filter(e => e.date === dateStr);
          };

          const handleDayClick = (day) => {
            const year = selectedDate.getFullYear();
            const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
            const dayStr = String(day).padStart(2, '0');
            const dateStr = `${year}-${month}-${dayStr}`;
            setFormData({ title: '', date: dateStr, time: '', description: '' });
            setEditingId(null);
            setShowForm(true);
          };

          const handleAddEvent = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            setFormData({ title: '', date: dateStr, time: '', description: '' });
            setEditingId(null);
            setShowForm(true);
          };

          const handleEditEvent = (event) => {
            setFormData(event);
            setEditingId(event.id);
            setShowForm(true);
          };

          const handleDeleteEvent = (id) => {
            const newEvents = events.filter(e => e.id !== id);
            saveEvents(newEvents);
          };

          const handleSubmit = () => {
            if (!formData.title || !formData.date) return;
            
            if (editingId) {
              const newEvents = events.map(e => 
                e.id === editingId ? { ...formData, id: editingId } : e
              );
              saveEvents(newEvents);
            } else {
              const newEvent = {
                ...formData,
                id: Date.now().toString()
              };
              saveEvents([...events, newEvent]);
            }
            
            setShowForm(false);
            setFormData({ title: '', date: '', time: '', description: '' });
          };

          const changeMonth = (delta) => {
            setSelectedDate(new Date(selectedDate.getFullYear(), selectedDate.getMonth() + delta, 1));
          };

          const renderCalendar = () => {
            const { daysInMonth, startingDayOfWeek } = getDaysInMonth(selectedDate);
            const cells = [];
            
            for (let i = 0; i < startingDayOfWeek; i++) {
              cells.push(<div key={`empty-${i}`} className="aspect-square"></div>);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
              const date = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), day);
              const dayEvents = getEventsForDate(date);
              const isToday = new Date().toDateString() === date.toDateString();
              
              cells.push(
                <div
                  key={day}
                  onClick={() => handleDayClick(day)}
                  className={`aspect-square border rounded-lg p-1 flex flex-col cursor-pointer transition hover:shadow-md ${
                    isToday ? 'bg-blue-50 border-blue-500' : 'border-gray-200 hover:border-purple-300'
                  }`}
                >
                  <div className={`text-sm font-semibold ${isToday ? 'text-blue-600' : 'text-gray-700'}`}>
                    {day}
                  </div>
                  {dayEvents.length > 0 && (
                    <div className="flex-1 flex flex-col gap-0.5 mt-1 overflow-hidden">
                      {dayEvents.slice(0, 2).map(event => (
                        <div
                          key={event.id}
                          className="text-xs bg-purple-500 text-white rounded px-1 truncate"
                          title={event.title}
                        >
                          {event.title}
                        </div>
                      ))}
                      {dayEvents.length > 2 && (
                        <div className="text-xs text-gray-500">+{dayEvents.length - 2}</div>
                      )}
                    </div>
                  )}
                </div>
              );
            }
            
            return cells;
          };

          const upcomingEvents = [...events]
            .sort((a, b) => {
              const dateA = new Date(a.date + ' ' + (a.time || '00:00'));
              const dateB = new Date(b.date + ' ' + (b.time || '00:00'));
              return dateA - dateB;
            })
            .filter(e => new Date(e.date + 'T00:00:00') >= new Date(new Date().toDateString()));

          const currentMonthImage = getCurrentMonthImage();

          return (
            <div className="min-h-screen bg-gradient-to-br from-purple-100 to-blue-100 p-4">
              <div className="max-w-4xl mx-auto">
                {showInstallButton && (
                  <div className="bg-purple-600 text-white p-4 rounded-2xl shadow-lg mb-4 flex items-center justify-between">
                    <div className="flex-1">
                      <p className="font-semibold">üì± Instala la app en tu m√≥vil</p>
                      <p className="text-sm text-purple-100">Accede m√°s r√°pido a tu calendario</p>
                    </div>
                    <button
                      onClick={handleInstallClick}
                      className="bg-white text-purple-600 px-4 py-2 rounded-lg font-semibold hover:bg-purple-50 transition flex items-center gap-2"
                    >
                      <Download className="w-5 h-5" />
                      Instalar
                    </button>
                  </div>
                )}

                <div className="bg-white rounded-2xl shadow-xl overflow-hidden mb-6">
                  {currentMonthImage ? (
                    <div className="relative h-48 overflow-hidden group">
                      <img 
                        src={currentMonthImage} 
                        alt={`Banner de ${months[selectedDate.getMonth()]}`}
                        className="w-full h-full object-cover"
                      />
                      <div className="absolute inset-0 bg-gradient-to-b from-transparent to-black/50 flex items-end">
                        <h2 className="text-white text-3xl font-bold p-6">
                          {months[selectedDate.getMonth()]} {selectedDate.getFullYear()}
                        </h2>
                      </div>
                      <button
                        onClick={removeMonthImage}
                        className="absolute top-4 right-4 bg-red-500 text-white p-2 rounded-lg opacity-0 group-hover:opacity-100 transition"
                      >
                        <X className="w-5 h-5" />
                      </button>
                    </div>
                  ) : (
                    <div 
                      onClick={() => setShowImageUpload(true)}
                      className="h-48 bg-gradient-to-r from-purple-400 to-blue-400 flex flex-col items-center justify-center cursor-pointer hover:from-purple-500 hover:to-blue-500 transition"
                    >
                      <Upload className="w-12 h-12 text-white mb-2" />
                      <p className="text-white text-lg font-semibold">A√±adir imagen del mes</p>
                      <p className="text-purple-100 text-sm">Click para subir</p>
                    </div>
                  )}

                  <div className="p-6">
                    <div className="flex items-center justify-between mb-6">
                      <div className="flex items-center gap-3">
                        <Calendar className="w-8 h-8 text-purple-600" />
                        <h1 className="text-3xl font-bold text-gray-800">Mi Calendario</h1>
                      </div>
                      <button
                        onClick={handleAddEvent}
                        className="bg-purple-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-purple-700 transition"
                      >
                        <Plus className="w-5 h-5" />
                        Nuevo
                      </button>
                    </div>

                    <div className="flex items-center justify-between mb-4">
                      <button
                        onClick={() => changeMonth(-1)}
                        className="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition"
                      >
                        ‚Üê Anterior
                      </button>
                      {!currentMonthImage && (
                        <button
                          onClick={() => setShowImageUpload(true)}
                          className="text-sm text-purple-600 hover:text-purple-700 flex items-center gap-1"
                        >
                          <Upload className="w-4 h-4" />
                          A√±adir imagen
                        </button>
                      )}
                      <button
                        onClick={() => changeMonth(1)}
                        className="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition"
                      >
                        Siguiente ‚Üí
                      </button>
                    </div>

                    <div className="grid grid-cols-7 gap-2 mb-2">
                      {days.map(day => (
                        <div key={day} className="text-center font-semibold text-gray-600 text-sm">
                          {day}
                        </div>
                      ))}
                    </div>

                    <div className="grid grid-cols-7 gap-2">
                      {renderCalendar()}
                    </div>

                    <p className="text-sm text-gray-500 mt-4 text-center">
                      üí° Click en cualquier d√≠a para a√±adir un evento
                    </p>
                  </div>
                </div>

                {upcomingEvents.length > 0 && (
                  <div className="bg-white rounded-2xl shadow-xl p-6">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">Pr√≥ximos Eventos</h2>
                    <div className="space-y-3">
                      {upcomingEvents.slice(0, 5).map(event => (
                        <div
                          key={event.id}
                          className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition"
                        >
                          <div className="flex justify-between items-start">
                            <div className="flex-1">
                              <h3 className="font-semibold text-gray-800 text-lg">{event.title}</h3>
                              <div className="flex items-center gap-4 mt-2 text-sm text-gray-600">
                                <span>üìÖ {new Date(event.date).toLocaleDateString('es-ES')}</span>
                                {event.time && (
                                  <span className="flex items-center gap-1">
                                    <Clock className="w-4 h-4" />
                                    {event.time}
                                  </span>
                                )}
                              </div>
                              {event.description && (
                                <p className="text-gray-600 mt-2">{event.description}</p>
                              )}
                            </div>
                            <div className="flex gap-2">
                              <button
                                onClick={() => handleEditEvent(event)}
                                className="text-blue-600 hover:bg-blue-50 p-2 rounded-lg transition"
                              >
                                <Edit2 className="w-5 h-5" />
                              </button>
                              <button
                                onClick={() => handleDeleteEvent(event.id)}
                                className="text-red-600 hover:bg-red-50 p-2 rounded-lg transition"
                              >
                                <Trash2 className="w-5 h-5" />
                              </button>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {showImageUpload && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md">
                      <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-gray-800">
                          Imagen para {months[selectedDate.getMonth()]}
                        </h2>
                        <button
                          onClick={() => setShowImageUpload(false)}
                          className="text-gray-500 hover:bg-gray-100 p-2 rounded-lg transition"
                        >
                          <X className="w-6 h-6" />
                        </button>
                      </div>

                      <div className="space-y-4">
                        <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-purple-500 transition">
                          <Upload className="w-12 h-12 text-gray-400 mx-auto mb-2" />
                          <p className="text-gray-600 mb-4">Selecciona una imagen</p>
                          <input
                            type="file"
                            accept="image/*"
                            onChange={handleImageUpload}
                            className="hidden"
                            id="imageUpload"
                          />
                          <label
                            htmlFor="imageUpload"
                            className="bg-purple-600 text-white px-6 py-2 rounded-lg cursor-pointer hover:bg-purple-700 transition inline-block"
                          >
                            Elegir archivo
                          </label>
                          <p className="text-sm text-gray-500 mt-2">JPG, PNG o GIF</p>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {showForm && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md">
                      <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-gray-800">
                          {editingId ? 'Editar Evento' : 'Nuevo Evento'}
                        </h2>
                        <button
                          onClick={() => setShowForm(false)}
                          className="text-gray-500 hover:bg-gray-100 p-2 rounded-lg transition"
                        >
                          <X className="w-6 h-6" />
                        </button>
                      </div>

                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">
                            T√≠tulo *
                          </label>
                          <input
                            type="text"
                            value={formData.title}
                            onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Cumplea√±os, cita, reuni√≥n..."
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">
                            Fecha *
                          </label>
                          <input
                            type="date"
                            value={formData.date}
                            onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">
                            Hora (opcional)
                          </label>
                          <input
                            type="time"
                            value={formData.time}
                            onChange={(e) => setFormData({ ...formData, time: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">
                            Descripci√≥n (opcional)
                          </label>
                          <textarea
                            value={formData.description}
                            onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            rows="3"
                            placeholder="Detalles adicionales..."
                          />
                        </div>

                        <div className="flex gap-3 pt-4">
                          <button
                            onClick={() => setShowForm(false)}
                            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                          >
                            Cancelar
                          </button>
                          <button
                            onClick={handleSubmit}
                            className="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
                          >
                            {editingId ? 'Guardar' : 'Crear'}
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        }

        // Renderizar la app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CalendarApp />);
    </script>
    
    <script>
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg => console.log('Service Worker registrado', reg))
                .catch(err => console.log('Error Service Worker', err));
        }
        
        // Inicializar iconos de Lucide
        lucide.createIcons();
    </script>
</body>
</html>
